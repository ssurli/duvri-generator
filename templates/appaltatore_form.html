{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üìã Dati Appaltatore - DUVRI Dinamico</h2>
    
    <!-- ALERT INFO OGGETTO -->
    {% if dati_committente and dati_committente.get('oggetto') %}
    <div class="alert alert-info">
        <strong>üìÑ Oggetto Appalto:</strong> {{ dati_committente.oggetto }}
    </div>
    {% endif %}

    <form method="POST">
        
        <!-- ============================================ -->
        <!-- SEZIONE 1: DATI ANAGRAFICI -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>1Ô∏è‚É£ Dati Anagrafici Impresa</h4>
            </div>
            <div class="card-body">
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Ragione Sociale *</label>
                        <input type="text" name="ragione_sociale" class="form-control" 
                               value="{{ data.get('ragione_sociale', '') }}" required
                               placeholder="es. ACME S.r.l.">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Codice Fiscale *</label>
                        <input type="text" name="cf" class="form-control" 
                               value="{{ data.get('cf', '') }}" required
                               placeholder="es. 12345678901">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold">P.IVA *</label>
                        <input type="text" name="piva" class="form-control" 
                               value="{{ data.get('piva', '') }}" required
                               placeholder="es. 12345678901">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Sede Legale *</label>
                        <input type="text" name="sede" class="form-control" 
                               value="{{ data.get('sede', '') }}" required
                               placeholder="Via, Citt√†, CAP">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Telefono *</label>
                        <input type="tel" name="telefono" class="form-control" 
                               value="{{ data.get('telefono', '') }}" required
                               placeholder="es. 055-1234567">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Email *</label>
                        <input type="email" name="email" class="form-control" 
                               value="{{ data.get('email', '') }}" required
                               placeholder="info@azienda.it">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">PEC *</label>
                        <input type="email" name="pec" class="form-control" 
                               value="{{ data.get('pec', '') }}" required
                               placeholder="pec@azienda.it">
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 2: FIGURE RESPONSABILI -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4>2Ô∏è‚É£ Figure Responsabili per la Sicurezza</h4>
            </div>
            <div class="card-body">
                
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Datore di Lavoro *</label>
                        <input type="text" name="datore_lavoro_nome" class="form-control" 
                               value="{{ data.get('datore_lavoro_nome', '') }}" required
                               placeholder="Nome e Cognome">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">RSPP *</label>
                        <input type="text" name="rspp_nome" class="form-control" 
                               value="{{ data.get('rspp_nome', '') }}" required
                               placeholder="Nome e Cognome">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Responsabile Appalto *</label>
                        <input type="text" name="resp_appalto_nome" class="form-control" 
                               value="{{ data.get('resp_appalto_nome', '') }}" required
                               placeholder="Nome e Cognome">
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 3: PARAMETRI OPERATIVI (per calcolo costi) -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4>3Ô∏è‚É£ Parametri Operativi</h4>
            </div>
            <div class="card-body">
                
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Informazione:</strong> Questi dati sono utilizzati per il calcolo automatico dei costi di sicurezza da parte del committente.
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Numero Massimo Addetti *</label>
                        <input type="number" name="max_addetti" class="form-control" 
                               value="{{ data.get('max_addetti', '') }}" required min="1"
                               placeholder="es. 3">
                        <small class="text-muted">Lavoratori presenti contemporaneamente</small>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Durata Lavori (giorni) *</label>
                        <input type="number" name="durata_giorni" class="form-control" 
                               value="{{ data.get('durata_giorni', '') }}" required min="1"
                               placeholder="es. 10">
                        <small class="text-muted">Giorni lavorativi previsti</small>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Orario Lavoro *</label>
                        <select name="orario_lavoro" class="form-select" required>
                            <option value="">Seleziona...</option>
                            <option value="diurno" {{ 'selected' if data.get('orario_lavoro') == 'diurno' else '' }}>
                                üåû Solo diurno (8-18)
                            </option>
                            <option value="h24" {{ 'selected' if data.get('orario_lavoro') == 'h24' else '' }}>
                                üåô H24 (anche notturno)
                            </option>
                            <option value="altro" {{ 'selected' if data.get('orario_lavoro') == 'altro' else '' }}>
                                üìÖ Altro (specificare)
                            </option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3" id="orario_altro_field" 
                     style="display: {{ 'block' if data.get('orario_lavoro') == 'altro' else 'none' }};">
                    <div class="col-md-12">
                        <label class="form-label">Specifica Orario</label>
                        <input type="text" name="orario_altro" class="form-control" 
                               value="{{ data.get('orario_altro', '') }}"
                               placeholder="es. Sabato 9-13">
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 4: ATTIVIT√Ä E RISCHI -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h4>4Ô∏è‚É£ Attivit√† e Rischi dell'Impresa</h4>
            </div>
            <div class="card-body">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Descrizione Attivit√†</label>
                    <textarea name="oggetto" class="form-control" rows="3" required
                              placeholder="Descrivere dettagliatamente le attivit√† che verranno svolte...">{{ data.get('oggetto', dati_committente.get('oggetto', '') if dati_committente else '') }}</textarea>
                </div>
                
                <hr>
                
                <h5>‚ö†Ô∏è Rischi delle Attivit√† dell'Impresa</h5>
                <p class="text-muted">Selezionare tutti i rischi associati alle attivit√† che verranno svolte:</p>
                
                <div class="row">
                    {% for codice, descrizione in rischi_paragrafi.items() %}
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="rischi" 
                                   value="{{ descrizione }}"
                                   id="rischio_{{ loop.index }}"
                                   {{ 'checked' if descrizione in data.get('rischi', []) else '' }}>
                            <label class="form-check-label" for="rischio_{{ loop.index }}">
                                <small><strong>{{ codice }}</strong> - {{ descrizione }}</small>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if rischi_hta %}
                <hr class="mt-3">
                <h6>üè• Rischi Specifici HTA (Health Technology Assessment)</h6>
                <div class="row">
                    {% for rischio in rischi_hta %}
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="rischi" 
                                   value="{{ rischio }}"
                                   id="rischio_hta_{{ loop.index }}"
                                   {{ 'checked' if rischio in data.get('rischi', []) else '' }}>
                            <label class="form-check-label" for="rischio_hta_{{ loop.index }}">
                                <small>{{ rischio }}</small>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <label class="form-label fw-bold">Note Aggiuntive sui Rischi</label>
                    <textarea name="note_rischi_struttura" class="form-control" rows="3"
                              placeholder="Eventuali specificazioni aggiuntive...">{{ data.get('note_rischi_struttura', '') }}</textarea>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 5: CARATTERISTICHE ATTREZZATURE (se applicabile) -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4>5Ô∏è‚É£ Caratteristiche Attrezzature (opzionale)</h4>
            </div>
            <div class="card-body">
                
                <p class="text-muted">Compilare solo se pertinente all'attivit√† svolta</p>
                
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Marca e Modello</label>
                        <input type="text" name="marca_modello" class="form-control" 
                               value="{{ data.get('marca_modello', '') }}"
                               placeholder="es. Siemens XYZ-123">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Potenza (kW)</label>
                        <input type="number" step="0.1" name="potenza_kw" class="form-control" 
                               value="{{ data.get('potenza_kw', '') }}"
                               placeholder="es. 15.5">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" step="0.1" name="peso_kg" class="form-control" 
                               value="{{ data.get('peso_kg', '') }}"
                               placeholder="es. 450">
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- BOTTONI AZIONE -->
        <!-- ============================================ -->
        
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('summary') }}" class="btn btn-secondary">
                ‚Üê Annulla
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                üíæ Salva Dati Appaltatore
            </button>
        </div>
        
    </form>
</div>

<!-- JavaScript per toggle campi -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Toggle campo "altro" per orario lavoro
    const orarioSelect = document.querySelector('[name="orario_lavoro"]');
    const orarioAltroField = document.getElementById('orario_altro_field');
    
    if (orarioSelect) {
        orarioSelect.addEventListener('change', function() {
            orarioAltroField.style.display = this.value === 'altro' ? 'block' : 'none';
        });
    }
    
});
</script>

<style>
.card-header h4 {
    margin: 0;
    font-size: 1.1rem;
}

.form-check-label {
    cursor: pointer;
}

.alert {
    border-radius: 8px;
}
</style>

{% endblock %}