{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üìã Dati Committente - DUVRI Dinamico</h2>
    
    <!-- ALERT INFORMATIVO TIPO DUVRI -->
    <div class="alert alert-info">
        <h5>‚ÑπÔ∏è Tipologie di DUVRI</h5>
        <ul class="mb-0">
            <li><strong>Ricognitivo:</strong> Per documenti di gara (stima preliminare costi sicurezza)</li>
            <li><strong>Operativo:</strong> Per esecuzione contratto (valutazione interferenze reali)</li>
        </ul>
    </div>

    <form method="POST" enctype="multipart/form-data">
        
        <!-- ============================================ -->
        <!-- SEZIONE 1: TIPO DUVRI E FASE APPALTO -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>1Ô∏è‚É£ Tipologia e Fase del DUVRI</h4>
            </div>
            <div class="card-body">
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Tipo DUVRI *</label>
                        <select name="tipo_duvri" class="form-select" required>
                            <option value="ricognitivo" {{ 'selected' if data.get('tipo_duvri') == 'ricognitivo' else '' }}>
                                üìÑ Ricognitivo (per documenti gara)
                            </option>
                            <option value="operativo" {{ 'selected' if data.get('tipo_duvri') == 'operativo' or not data.get('tipo_duvri') else '' }}>
                                üîß Operativo (per esecuzione contratto)
                            </option>
                        </select>
                        <small class="text-muted">
                            Ricognitivo = stima per bando | Operativo = interferenze reali
                        </small>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fase Appalto *</label>
                        <select name="fase_appalto" class="form-select" required>
                            <option value="progettazione" {{ 'selected' if data.get('fase_appalto') == 'progettazione' else '' }}>
                                üìê Progettazione/Gara
                            </option>
                            <option value="esecuzione" {{ 'selected' if data.get('fase_appalto') == 'esecuzione' or not data.get('fase_appalto') else '' }}>
                                üî® Esecuzione contratto
                            </option>
                        </select>
                    </div>
                </div>
                
                <!-- Upload DUVRI ESTAR -->
                <div class="mt-3">
                    <label class="form-label fw-bold">üìé DUVRI ESTAR/Preliminare (opzionale)</label>
                    <input type="file" name="duvri_estar_file" class="form-control" accept=".pdf,.doc,.docx">
                    <small class="text-muted">
                        Carica il DUVRI preliminare fornito da ESTAR o altra centrale di committenza
                    </small>
                    
                    {% if data.get('duvri_estar_filename') %}
                    <div class="alert alert-success mt-2">
                        ‚úÖ File caricato: <strong>{{ data.duvri_estar_filename }}</strong>
                        <a href="{{ url_for('scarica_duvri_estar', duvri_id=current_duvri_id) }}" 
                           class="btn btn-sm btn-primary ms-2">üì• Scarica</a>
                    </div>
                    {% endif %}
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 2: DATI ANAGRAFICI COMMITTENTE -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4>2Ô∏è‚É£ Dati Anagrafici Committente</h4>
            </div>
            <div class="card-body">
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">RUP/Responsabile Committente *</label>
                        <input type="text" name="nome" class="form-control" 
                               value="{{ data.get('nome', '') }}" required
                               placeholder="es. Dott. Mario Rossi">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Codice Fiscale/P.IVA *</label>
                        <input type="text" name="codice_fiscale" class="form-control" 
                               value="{{ data.get('codice_fiscale', '') }}" required
                               placeholder="es. 02198590503">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Indirizzo Sede *</label>
                        <input type="text" name="indirizzo" class="form-control" 
                               value="{{ data.get('indirizzo', '') }}" required
                               placeholder="es. Via Roma 1, 50100 Firenze">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Email *</label>
                        <input type="email" name="email" class="form-control" 
                               value="{{ data.get('email', '') }}" required
                               placeholder="rup@asl.toscana.it">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Oggetto Appalto/Servizio *</label>
                        <textarea name="oggetto" class="form-control" rows="2" required
                                  placeholder="es. Fornitura in locazione di 2 colonne endoscopiche">{{ data.get('oggetto', '') }}</textarea>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 3: IMPORTI E COSTI GARA -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4>3Ô∏è‚É£ Importi Appalto e Costi Sicurezza da Gara</h4>
            </div>
            <div class="card-body">
                
                <!-- ALERT ESPLICATIVO -->
                <div class="alert alert-info">
                    <h5>üìñ Istruzioni sui Costi da Gara</h5>
                    <p class="mb-2"><strong>Seleziona lo scenario corretto:</strong></p>
                    
                    <div class="ms-3">
                        <p class="mb-2">
                            <strong>‚úÖ Scenario A - Costi gi√† inclusi ed evidenziati:</strong><br>
                            <small>
                                ‚òëÔ∏è Spunta "Costi sicurezza inclusi"<br>
                                üìù Compila "Importo costi sicurezza" = importo dichiarato nei documenti<br>
                                üí° <em>Sistema calcoler√† delta e gestir√† atto aggiuntivo se necessario (art. 120)</em>
                            </small>
                        </p>
                        
                        <p class="mb-2">
                            <strong>‚öñÔ∏è Scenario B - Costi inclusi ma compensati (non evidenziati):</strong><br>
                            <small>
                                ‚òëÔ∏è Spunta "Costi sicurezza inclusi"<br>
                                üìù <strong>LASCIA VUOTO</strong> "Importo costi sicurezza" o imposta 0‚Ç¨<br>
                                üí° <em>Sistema applicher√† compensazione interna con verbale coordinamento</em>
                            </small>
                        </p>
                        
                        <p class="mb-0">
                            <strong>‚ùå Scenario C - Costi NON inclusi in gara:</strong><br>
                            <small>
                                ‚òê NON spuntare "Costi sicurezza inclusi"<br>
                                üí° <em>Tutti i costi operativi saranno extra-costi ‚Üí atto aggiuntivo necessario (art. 120)</em>
                            </small>
                        </p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Importo Base Gara (‚Ç¨) *</label>
                        <input type="number" step="0.01" name="importo_gara_base" 
                               class="form-control" 
                               value="{{ data.get('importo_gara_base', '') }}" 
                               required
                               placeholder="es. 50000.00">
                        <small class="text-muted">Importo contrattuale (IVA esclusa)</small>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check mt-4 pt-2">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   id="costi_inclusi_gara" 
                                   name="costi_inclusi_gara"
                                   {{ 'checked' if data.get('costi_inclusi_gara') else '' }}>
                            <label class="form-check-label fw-bold" for="costi_inclusi_gara">
                                Costi sicurezza da interferenze gi√† inclusi nei documenti di gara
                            </label>
                            <small class="d-block text-muted mt-1">
                                Selezionare se ESTAR (o altra centrale) ha gi√† incluso costi sicurezza
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3" id="importo_costi_gara_section" 
                     style="display: {{ 'block' if data.get('costi_inclusi_gara') else 'none' }};">
                    <div class="col-md-12">
                        <div class="alert alert-warning">
                            <h6>‚ö†Ô∏è ATTENZIONE - Compila con cura:</h6>
                            <ul class="mb-0">
                                <li><strong>Se i costi sono evidenziati nei documenti</strong> ‚Üí inserisci l'importo esatto</li>
                                <li><strong>Se i costi sono compensati (non evidenziati)</strong> ‚Üí lascia a 0 o vuoto</li>
                            </ul>
                        </div>
                        
                        <label class="form-label fw-bold">Importo Costi Sicurezza da Gara (‚Ç¨)</label>
                        <input type="number" step="0.01" name="costi_sicurezza_gara" 
                               class="form-control" 
                               value="{{ data.get('costi_sicurezza_gara', '0') }}"
                               placeholder="0.00 per costi compensati, oppure importo dichiarato">
                        <small class="text-muted">
                            <strong>0 o vuoto</strong> = costi compensati  | 
                            <strong>Valore > 0</strong> = confronto per atto aggiuntivo (art. 120)
                        </small>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 4: CARATTERISTICHE STRUTTURA -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4>4Ô∏è‚É£ Caratteristiche Struttura e Ambiente</h4>
            </div>
            <div class="card-body">
                
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tipologia Struttura *</label>
                        <select name="tipologia_struttura" class="form-select" required>
                            <option value="">Seleziona...</option>
                            <option value="ospedale" {{ 'selected' if data.get('tipologia_struttura') == 'ospedale' else '' }}>
                                üè• Ospedale
                            </option>
                            <option value="poliambulatorio" {{ 'selected' if data.get('tipologia_struttura') == 'poliambulatorio' else '' }}>
                                üè¢ Poliambulatorio
                            </option>
                            <option value="rsa" {{ 'selected' if data.get('tipologia_struttura') == 'rsa' else '' }}>
                                üè† RSA/Casa di Cura
                            </option>
                            <option value="laboratorio" {{ 'selected' if data.get('tipologia_struttura') == 'laboratorio' else '' }}>
                                üî¨ Laboratorio
                            </option>
                            <option value="altro" {{ 'selected' if data.get('tipologia_struttura') == 'altro' else '' }}>
                                üìã Altro
                            </option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Area Installazione *</label>
                        <input type="text" name="area_installazione" class="form-control" 
                               value="{{ data.get('area_installazione', '') }}" required
                               placeholder="es. Reparto Endoscopia, 2¬∞ piano">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Presenza Pazienti *</label>
                        <select name="presenza_pazienti" class="form-select" required>
                            <option value="">Seleziona...</option>
                            <option value="si_continua" {{ 'selected' if data.get('presenza_pazienti') == 'si_continua' else '' }}>
                                üë• S√¨, continuativa (H24)
                            </option>
                            <option value="si_diurna" {{ 'selected' if data.get('presenza_pazienti') == 'si_diurna' else '' }}>
                                üë§ S√¨, solo diurna
                            </option>
                            <option value="no" {{ 'selected' if data.get('presenza_pazienti') == 'no' else '' }}>
                                ‚úÖ No, area non operativa
                            </option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Orari Lavori Consentiti</label>
                        <input type="text" name="orari_lavori" class="form-control" 
                               value="{{ data.get('orari_lavori', '') }}"
                               placeholder="es. Lun-Ven 8:00-18:00, no weekend">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Referente Tecnico ASL</label>
                        <input type="text" name="referente_tecnico" class="form-control" 
                               value="{{ data.get('referente_tecnico', '') }}"
                               placeholder="Nome, ruolo, telefono">
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 5: RISCHI DELLA STRUTTURA -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h4>5Ô∏è‚É£ Rischi Presenti nella Struttura Committente</h4>
            </div>
            <div class="card-body">
                
                <p class="text-muted">Seleziona i rischi presenti nell'area dove si svolgeranno i lavori:</p>
                
                <div class="row">
                    {% for rischio in rischi_committente %}
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="rischi_struttura" 
                                   value="{{ rischio }}"
                                   id="rischio_{{ loop.index }}"
                                   {{ 'checked' if rischio in data.get('rischi_struttura', []) else '' }}>
                            <label class="form-check-label" for="rischio_{{ loop.index }}">
                                {{ rischio }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <label class="form-label fw-bold">Note Aggiuntive sui Rischi</label>
                    <textarea name="note_rischi_struttura" class="form-control" rows="3"
                              placeholder="Specificare particolari situazioni, vincoli, procedure...">{{ data.get('note_rischi_struttura', '') }}</textarea>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SEZIONE 6: COSTI SICUREZZA (OPZIONALE) -->
        <!-- ============================================ -->
        
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4>6Ô∏è‚É£ Definizione Costi Sicurezza da Interferenze (Opzionale)</h4>
            </div>
            <div class="card-body">
                
                <div class="alert alert-secondary">
                    <h5>‚ÑπÔ∏è Calcolo Costi</h5>
                    <p class="mb-2">Puoi scegliere tra:</p>
                    <ul class="mb-0">
                        <li><strong>Calcolo Automatico:</strong> Il sistema calcola i costi in base a parametri (lavoratori, durata, rischi)</li>
                        <li><strong>Inserimento Manuale:</strong> Inserisci tu i costi per ogni voce (utile se hai gi√† una stima)</li>
                    </ul>
                </div>
                
                <!-- Checkbox Costi Manuali -->
                <div class="form-check form-switch mb-3">
                    <input type="checkbox" 
                           class="form-check-input" 
                           id="usa_costi_manuali" 
                           name="usa_costi_manuali"
                           {{ 'checked' if data.get('usa_costi_manuali') else '' }}>
                    <label class="form-check-label fw-bold" for="usa_costi_manuali">
                        üñäÔ∏è Inserisci costi manualmente (disabilita calcolo automatico)
                    </label>
                </div>
                
                <!-- Sezione Calcolo Automatico -->
                <div id="calcolo_automatico_section" 
                     style="display: {{ 'none' if data.get('usa_costi_manuali') else 'block' }};">
                    <h5>‚öôÔ∏è Parametri Calcolo Automatico</h5>
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label">Percentuale Costo Base (%) 
                                <small class="text-muted">
                                    ‚ÑπÔ∏è Percentuale sull'importo appalto per costi base (default 2%)
                                </small>
                            </label>
                            <input type="number" step="0.1" name="percentuale_costo_base" 
                                   class="form-control" 
                                   value="{{ data.get('percentuale_costo_base', '2.0') }}"
                                   placeholder="2.0"
                                   min="0" max="5">
                            <small class="text-muted">
                                Imposta 0 per nessun costo base, oppure 1-3% tipicamente
                            </small>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <small>
                            üí° Il sistema calcoler√† automaticamente i costi quando l'appaltatore inserir√†:
                            numero lavoratori, durata lavori e rischi
                        </small>
                    </div>
                </div>
                
                <!-- Sezione Costi Manuali -->
                <div id="costi_manuali_section" 
                     style="display: {{ 'block' if data.get('usa_costi_manuali') else 'none' }};">
                    <h5>üí∞ Inserimento Manuale Costi</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Incontri e coordinamento (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_incontri_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_incontri_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">DPI specifici (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_dpi_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_dpi_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Impiantistica ausiliaria (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_impiantistica_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_impiantistica_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Segnaletica (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_segnaletica_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_segnaletica_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Presidi antincendio (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_presidi_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_presidi_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Controlli periodici (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_controlli_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_controlli_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Altre misure (‚Ç¨)</label>
                            <input type="number" step="0.01" name="costo_altre_misure_manuale" 
                                   class="form-control" 
                                   value="{{ data.get('costo_altre_misure_manuale', '') }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- ============================================ -->
        <!-- BOTTONI AZIONE -->
        <!-- ============================================ -->
        
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                ‚Üê Annulla
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                üíæ Salva Dati Committente
            </button>
        </div>
        
    </form>
</div>

<!-- JavaScript per toggle sezioni -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Toggle importo costi gara
    const checkboxCostiInclusi = document.getElementById('costi_inclusi_gara');
    const importoCostiSection = document.getElementById('importo_costi_gara_section');
    
    if (checkboxCostiInclusi) {
        checkboxCostiInclusi.addEventListener('change', function() {
            importoCostiSection.style.display = this.checked ? 'block' : 'none';
        });
    }
    
    // Toggle costi manuali vs automatici
    const checkboxCostiManuali = document.getElementById('usa_costi_manuali');
    const calcoloAutoSection = document.getElementById('calcolo_automatico_section');
    const costiManualiSection = document.getElementById('costi_manuali_section');
    
    if (checkboxCostiManuali) {
        checkboxCostiManuali.addEventListener('change', function() {
            if (this.checked) {
                calcoloAutoSection.style.display = 'none';
                costiManualiSection.style.display = 'block';
            } else {
                calcoloAutoSection.style.display = 'block';
                costiManualiSection.style.display = 'none';
            }
        });
    }
    
});
</script>

<style>
.card-header h4 {
    margin: 0;
    font-size: 1.1rem;
}

.alert h5, .alert h6 {
    margin-top: 0;
}

.form-check-label {
    cursor: pointer;
}

.alert ul {
    padding-left: 1.5rem;
}
</style>

{% endblock %}